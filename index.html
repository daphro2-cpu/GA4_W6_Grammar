<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Grammar Practice â€¢ Unit 4 (Part 2) + Unit 5 (Click Only)</title>
  <style>
    :root{
      --bg:#0f172a;
      --panel:#111c33;
      --card:#0b1226;
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --line:#24324f;
      --good:#22c55e;
      --bad:#ef4444;
      --accent:#60a5fa;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Century Gothic", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% 10%, #1a2a55 0%, var(--bg) 60%);
      color:var(--ink);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 40px}

    header{
      display:flex;gap:12px;align-items:flex-start;justify-content:space-between;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(96,165,250,.15), rgba(96,165,250,.04));
      padding:14px;border-radius:14px;
    }
    .brand{display:flex;gap:12px;align-items:center;min-width:0}
    .logo{
      width:56px;height:56px;object-fit:contain;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(11,18,38,.55);
      padding:6px;flex:0 0 auto;
    }
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35}

    .meta{display:flex;flex-direction:column;gap:8px;align-items:flex-end;min-width:260px}
    .pillrow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      font-size:12px;border:1px solid var(--line);background: rgba(17,28,51,.7);
      padding:6px 10px;border-radius:999px;user-select:none;
    }
    .pill b{color:#fff}
    .bar{
      width:260px;height:10px;background: rgba(255,255,255,.07);
      border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.10);
    }
    .bar>div{
      height:100%;width:0%;
      background: linear-gradient(90deg, #60a5fa, #34d399);
      transition: width .25s ease;
    }

    main{margin-top:14px;display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    @media (max-width: 860px){
      main{grid-template-columns:1fr}
      .meta{align-items:flex-start;min-width:0}
      .pillrow{justify-content:flex-start}
      .bar{width:100%}
    }
    @media (max-width: 520px){ .logo{width:44px;height:44px} }

    .panel{
      border:1px solid var(--line);
      background: rgba(17,28,51,.55);
      border-radius:14px;
      padding:12px;
    }
    .panel h2{
      margin:0 0 10px;font-size:14px;color:#fff;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .tag{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      background: rgba(11,18,38,.7);
      padding:4px 8px;border-radius:999px;
    }

    .card{
      border:1px solid var(--line);
      background: rgba(11,18,38,.7);
      border-radius:14px;
      padding:14px;
    }
    .qtype{font-size:12px;color:var(--muted);margin-bottom:6px}
    .prompt{font-size:16px;line-height:1.35;margin:0 0 10px}
    .sentence{
      font-size:14px;color:#dbe3ff;
      border-left:3px solid rgba(96,165,250,.5);
      padding-left:10px;margin:10px 0 12px;line-height:1.55;
    }
    .mini{font-size:12.5px;color:var(--muted);line-height:1.4;margin-top:8px}
    .feedback{
      margin-top:10px;
      font-size:13px;color:var(--muted);
      line-height:1.4;
      min-height: 22px;
    }
    .feedback b{color:#fff}
    .feedback .good{color: var(--good)}
    .feedback .bad{color: var(--bad)}
    .feedback .hint{color: #cbd5e1}

    .controls{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    button.smallbtn{
      width:auto;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(34,211,238,.20), rgba(31,42,68,.65));
      color:var(--ink);
      border-radius:12px;
      padding:10px 14px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    button.smallbtn.secondary{
      background: linear-gradient(180deg, rgba(96,165,250,.12), rgba(31,42,68,.65));
      border-color: rgba(96,165,250,.25);
    }
    button.smallbtn[disabled]{opacity:.55;cursor:not-allowed}

    .tileRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .tileBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(31,42,68,.7);
      padding:8px 12px;border-radius:999px;
      cursor:pointer;user-select:none;font-size:14px;
      color: var(--ink);
      transition: transform .05s ease, border-color .2s ease;
    }
    .tileBtn:hover{border-color: rgba(96,165,250,.55)}
    .tileBtn:active{transform: translateY(1px)}
    .tileBtn.selected{
      border-color: rgba(34,197,94,.7);
      background: rgba(34,197,94,.18);
    }

    .clozeLine{
      font-size:16px; line-height:1.6;
      padding:12px 12px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      background: rgba(11,18,38,.45);
    }
    .blank{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:120px;
      padding:2px 8px;
      border-bottom:2px solid rgba(96,165,250,.75);
      color:#fff;
      font-weight:600;
    }

    .emojiRow{font-size: 20px; line-height: 1; margin-top: 8px; min-height: 24px}

    .done{
      display:none;margin-top:10px;padding:12px;border-radius:14px;
      border:1px solid rgba(34,197,94,.35);
      background: rgba(34,197,94,.10);
    }
    .done h3{margin:0 0 6px;font-size:15px}
    .done p{margin:0;color:var(--muted);font-size:13px;line-height:1.45}
    .reviewBox{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(11,18,38,.55);
      border-radius:12px;
      padding:10px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(31,42,68,.55);
      padding:6px 10px;
      border-radius:999px;
      font-size:12.5px;
      color: var(--ink);
    }

    .twoCol{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 620px){ .twoCol{grid-template-columns:1fr} }
    .matchBox{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(11,18,38,.55);
      border-radius:12px;
      padding:10px;
    }
    .matchTitle{font-size:12px;color:var(--muted);margin-bottom:8px}
    .matchItem{
      display:flex;align-items:center;justify-content:space-between;
      padding:8px 10px;border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(31,42,68,.45);
      margin-bottom:8px;
      gap:10px;
    }
    .matchItem:last-child{margin-bottom:0}
    .matchItem b{font-weight:600}
    select.matchSel{
      border-radius:10px;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(17,28,51,.65);
      color: var(--ink);
      font-size:13px;
      outline:none;
      cursor:pointer;
      min-width: 180px;
    }
    select.matchSel:focus{border-color: rgba(96,165,250,.55)}
    .ok{border-color: rgba(34,197,94,.65)!important}
    .badBorder{border-color: rgba(239,68,68,.65)!important}
    .smallNote{font-size:12.5px;color:var(--muted);margin-top:8px;line-height:1.4}

    .picWrap{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(11,18,38,.45);
      border-radius:12px;
      padding:10px;
      margin:10px 0 10px;
    }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <img src="logo.png" alt="Logo" class="logo" />
      <div>
        <h1>Grammar Practice â€¢ Unit 4 (Part 2) + Unit 5</h1>
        <div class="sub">
          <b>Click-only.</b> No typing. Do each part in order (organized by exercise type).
        </div>
      </div>
    </div>

    <div class="meta">
      <div class="pillrow">
        <div class="pill"><b>Part</b> <span id="partTxt">A</span></div>
        <div class="pill"><b>Progress</b> <span id="progTxt">0/0</span></div>
        <div class="pill"><b>Score</b> <span id="scoreTxt">0</span></div>
        <div class="pill"><b>Time</b> <span id="timeTxt">10:00</span></div>
      </div>
      <div class="bar"><div id="progBar"></div></div>
    </div>
  </header>

  <main>
    <section class="panel">
      <h2>
        <span id="sectionTitle">Loadingâ€¦</span>
        <span class="tag" id="sectionTag">Practice</span>
      </h2>

      <div class="card" id="cardArea"></div>

      <div class="done" id="doneBox">
        <h3>Finished!</h3>
        <p id="endMsg"></p>

        <div class="reviewBox" id="reviewBox"></div>

        <div class="controls">
          <button class="smallbtn secondary" id="reviewWrongBtn">Practice Review (Only What I Missed)</button>
          <button class="smallbtn" id="restartBtn">Restart</button>
        </div>
      </div>
    </section>

    <aside class="panel">
      <h2>Structure <span class="tag">Organized</span></h2>
      <ul style="margin:0;padding-left:18px;color:var(--muted);font-size:12.5px;line-height:1.45">
        <li><b>Part A</b> â€” Cloze (click to fill): my/mine, their/theirs, have/has got</li>
        <li><b>Part B</b> â€” Same meaning (matching)</li>
        <li><b>Part C</b> â€” Apostrophe & ownership: whose vs whoâ€™s, â€™s = is/has/possessive</li>
        <li><b>Part D</b> â€” There is/are: forms, questions, short answers (MCQ)</li>
        <li><b>Part E</b> â€” Prepositions + fixed expressions + corner (MCQ + picture MCQ)</li>
      </ul>

      <div style="margin-top:12px;border-left:3px solid rgba(245,158,11,.55);padding-left:10px;color:var(--muted);font-size:12.5px;line-height:1.45">
        <b>Teacher note:</b> This version is designed to test grammar choice quickly (fast diagnostic).
      </div>
    </aside>
  </main>
</div>

<script>
(() => {
  const TOTAL_TIME_SEC = 10 * 60;

  // ---------- Picture ----------
  function getRoomSVG(){
    return `
      <div class="picWrap">
        <svg viewBox="0 0 720 240" width="100%" height="auto" role="img" aria-label="Room picture">
          <rect x="0" y="160" width="720" height="80" fill="rgba(96,165,250,.08)"></rect>
          <rect x="640" y="0" width="10" height="240" fill="rgba(245,158,11,.25)"></rect>
          <text x="655" y="20" font-size="12" fill="rgba(156,163,175,.9)">WALL</text>

          <rect x="60" y="90" width="180" height="20" rx="6" fill="rgba(96,165,250,.35)"></rect>
          <rect x="70" y="110" width="20" height="60" fill="rgba(96,165,250,.22)"></rect>
          <rect x="210" y="110" width="20" height="60" fill="rgba(96,165,250,.22)"></rect>
          <text x="65" y="80" font-size="12" fill="rgba(156,163,175,.9)">DESK</text>

          <rect x="120" y="65" width="60" height="25" rx="4" fill="rgba(34,197,94,.35)" stroke="rgba(34,197,94,.55)"></rect>
          <text x="127" y="82" font-size="12" fill="rgba(229,231,235,.95)">BOOK</text>

          <rect x="310" y="105" width="100" height="18" rx="6" fill="rgba(156,163,175,.25)"></rect>
          <rect x="322" y="123" width="14" height="60" fill="rgba(156,163,175,.18)"></rect>
          <rect x="384" y="123" width="14" height="60" fill="rgba(156,163,175,.18)"></rect>
          <text x="315" y="95" font-size="12" fill="rgba(156,163,175,.9)">CHAIR</text>

          <rect x="340" y="172" width="40" height="28" rx="6" fill="rgba(239,68,68,.28)" stroke="rgba(239,68,68,.55)"></rect>
          <text x="346" y="191" font-size="12" fill="rgba(229,231,235,.95)">BAG</text>

          <circle cx="520" cy="110" r="16" fill="rgba(245,158,11,.25)" stroke="rgba(245,158,11,.55)"></circle>
          <rect x="515" y="126" width="10" height="40" fill="rgba(245,158,11,.22)"></rect>
          <rect x="500" y="166" width="40" height="10" rx="5" fill="rgba(245,158,11,.22)"></rect>
          <text x="500" y="95" font-size="12" fill="rgba(156,163,175,.9)">LAMP</text>
        </svg>
      </div>
    `;
  }

  // ---------- Utils ----------
  function shuffle(arr){
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }
  function formatTime(sec){
    const m = String(Math.floor(sec/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");
    return `${m}:${s}`;
  }
  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  // ---------- ITEMS (GROUPED BY TYPE / PART) ----------
  // Types:
  // cloze_click = click options to fill blank
  // matching = same meaning matching (dropdown click only)
  // mcq = multiple choice
  // pic_mcq = picture + mcq

  const ITEMS = [
    // =========================
    // PART A â€” CLOZE (CLICK)
    // =========================
    { part:"A", section:"Part A â€” Cloze (Click to fill)", tag:"Possessives & have/has got", type:"cloze_click",
      prompt:"Choose the best word for the blank.",
      line:"This is ____ book.",
      options:["my","mine","me","I"],
      answer:"my",
      clue:"Before a noun â†’ my/your/his/her/our/their.",
      success:"Correct. Before a noun â†’ <b>my</b>."
    },
    { part:"A", section:"Part A â€” Cloze (Click to fill)", tag:"Possessives", type:"cloze_click",
      prompt:"Choose the best word for the blank.",
      line:"This book is ____.",
      options:["my","mine","me","I"],
      answer:"mine",
      clue:"No noun after blank â†’ mine/yours/hers/ours/theirs.",
      success:"Correct. No noun â†’ <b>mine</b>."
    },
    { part:"A", section:"Part A â€” Cloze (Click to fill)", tag:"Possessives", type:"cloze_click",
      prompt:"Choose the best word for the blank.",
      line:"Those are ____ bags.",
      options:["their","theirs","them","they"],
      answer:"their",
      clue:"Before a noun â†’ their.",
      success:"Correct. Before a noun â†’ <b>their</b>."
    },
    { part:"A", section:"Part A â€” Cloze (Click to fill)", tag:"Possessives", type:"cloze_click",
      prompt:"Choose the best word for the blank.",
      line:"Those bags are ____.",
      options:["their","theirs","them","they"],
      answer:"theirs",
      clue:"No noun â†’ theirs.",
      success:"Correct. No noun â†’ <b>theirs</b>."
    },
    { part:"A", section:"Part A â€” Cloze (Click to fill)", tag:"Have/has got", type:"cloze_click",
      prompt:"Choose the best phrase (meaning = have).",
      line:"I ____ two brothers.",
      options:["have got","has got","am got","got"],
      answer:"have got",
      clue:"I/you/we/they â†’ have got. He/she/it â†’ has got.",
      success:"Correct. I <b>have got</b>â€¦"
    },
    { part:"A", section:"Part A â€” Cloze (Click to fill)", tag:"Have/has got", type:"cloze_click",
      prompt:"Choose the best phrase (meaning = have).",
      line:"She ____ a new pencil case.",
      options:["has got","have got","is got","got"],
      answer:"has got",
      clue:"He/she/it â†’ has got.",
      success:"Correct. She <b>has got</b>â€¦"
    },

    // =========================
    // PART B â€” SAME MEANING (MATCHING)
    // =========================
    { part:"B", section:"Part B â€” Same meaning (Matching)", tag:"my/mine + her/hers + their/theirs", type:"matching",
      prompt:"Match the sentences that mean the same thing.",
      pairsA:[
        "1) This is my bag.",
        "2) Those are her shoes.",
        "3) That book is his.",
        "4) These are our tickets.",
        "5) Those keys are mine."
      ],
      pairsB:[
        "a) Itâ€™s mine.",
        "b) Theyâ€™re hers.",
        "c) Thatâ€™s his book.",
        "d) Theyâ€™re ours.",
        "e) Theyâ€™re my keys."
      ],
      // A index -> B letter
      answerMap:{0:"a",1:"b",2:"c",3:"d",4:"e"},
      clue:"Rule: my + noun / mine (no noun). her shoes / hers.",
      success:"Nice. Same meaning = same ownership."
    },

    // =========================
    // PART C â€” â€™s / WHOSE / WHOâ€™S (ALL MCQ)
    // =========================
    { part:"C", section:"Part C â€” Apostrophes & ownership", tag:"whose vs whoâ€™s", type:"mcq",
      qtype:"Choose the correct word",
      prompt:"Choose the correct word.",
      sentence:"_____ pencil is this?",
      choices:[
        {t:"Whose", ok:true},
        {t:"Whoâ€™s", ok:false},
        {t:"Who", ok:false},
        {t:"Whos", ok:false}
      ],
      clue:"Whose = ownership. Whoâ€™s = who is.",
      success:"Correct. <b>Whose</b> asks about ownership."
    },
    { part:"C", section:"Part C â€” Apostrophes & ownership", tag:"â€™s meaning", type:"mcq",
      qtype:"What does â€™s mean?",
      prompt:"In this sentence, what does <b>Tomâ€™s</b> mean?",
      sentence:"Tomâ€™s backpack is under the chair.",
      choices:[
        {t:"Tom owns the backpack (possessive).", ok:true},
        {t:"Tom is a backpack.", ok:false},
        {t:"Tom has got (always).", ok:false},
        {t:"Tom was.", ok:false}
      ],
      clue:"Name + â€™s + noun â†’ belongs to.",
      success:"Correct. Tomâ€™s = belonging to Tom."
    },
    { part:"C", section:"Part C â€” Apostrophes & ownership", tag:"â€™s meaning", type:"mcq",
      qtype:"What does â€™s mean?",
      prompt:"In this sentence, what does <b>Itâ€™s</b> mean?",
      sentence:"Itâ€™s on the desk.",
      choices:[
        {t:"It is", ok:true},
        {t:"It has", ok:false},
        {t:"Its (possessive adjective)", ok:false},
        {t:"It owns", ok:false}
      ],
      clue:"Itâ€™s = it is. Its = belonging to it.",
      success:"Correct. Itâ€™s = <b>It is</b>."
    },
    { part:"C", section:"Part C â€” Apostrophes & ownership", tag:"â€™s meaning", type:"mcq",
      qtype:"What does â€™s mean?",
      prompt:"In this sentence, what does <b>Sheâ€™s got</b> mean?",
      sentence:"Sheâ€™s got a new pencil case.",
      choices:[
        {t:"She has got", ok:true},
        {t:"She is got", ok:false},
        {t:"She was got", ok:false},
        {t:"She owns got", ok:false}
      ],
      clue:"â€™s got = has got.",
      success:"Correct. Sheâ€™s got = <b>She has got</b>."
    },

    // =========================
    // PART D â€” THERE IS/ARE (ALL MCQ)
    // =========================
    { part:"D", section:"Part D â€” There is / There are", tag:"positive", type:"mcq",
      qtype:"Choose the correct form",
      prompt:"Choose the correct sentence.",
      sentence:"(One thing)",
      choices:[
        {t:"There is a lamp on the desk.", ok:true},
        {t:"There are a lamp on the desk.", ok:false},
        {t:"Is there a lamp on the desk.", ok:false},
        {t:"There lamp is on the desk.", ok:false}
      ],
      clue:"Singular â†’ there is.",
      success:"Correct. Singular â†’ <b>There is</b>."
    },
    { part:"D", section:"Part D â€” There is / There are", tag:"positive", type:"mcq",
      qtype:"Choose the correct form",
      prompt:"Choose the correct sentence.",
      sentence:"(Two things)",
      choices:[
        {t:"There are two books on the chair.", ok:true},
        {t:"There is two books on the chair.", ok:false},
        {t:"Are there two book on the chair?", ok:false},
        {t:"There two books are on the chair.", ok:false}
      ],
      clue:"Plural â†’ there are.",
      success:"Correct. Plural â†’ <b>There are</b>."
    },
    { part:"D", section:"Part D â€” There is / There are", tag:"questions", type:"mcq",
      qtype:"Question form",
      prompt:"Choose the correct question.",
      sentence:"(One thing)",
      choices:[
        {t:"Is there a computer in the classroom?", ok:true},
        {t:"Are there a computer in the classroom?", ok:false},
        {t:"Is it there a computer in the classroom?", ok:false},
        {t:"Do there have a computer in the classroom?", ok:false}
      ],
      clue:"Singular question â†’ Is thereâ€¦?",
      success:"Correct. <b>Is thereâ€¦?</b>"
    },
    { part:"D", section:"Part D â€” There is / There are", tag:"questions", type:"mcq",
      qtype:"Question form",
      prompt:"Choose the correct question.",
      sentence:"(Many things)",
      choices:[
        {t:"Are there any pencils on the desk?", ok:true},
        {t:"Is there any pencils on the desk?", ok:false},
        {t:"Are any pencils there on the desk?", ok:false},
        {t:"Do there are any pencils on the desk?", ok:false}
      ],
      clue:"Plural â†’ Are thereâ€¦?",
      success:"Correct. <b>Are thereâ€¦?</b>"
    },
    { part:"D", section:"Part D â€” There is / There are", tag:"short answers", type:"mcq",
      qtype:"Short answers (NO typing)",
      prompt:"Choose the best short answer.",
      sentence:"Q: Is there a computer in the classroom?",
      choices:[
        {t:"Yes, there is.", ok:true},
        {t:"Yes, it is.", ok:false},
        {t:"Yes, there are.", ok:false},
        {t:"Yes, there isnâ€™t.", ok:false}
      ],
      clue:"Short answers use THERE: Yes, there is / No, there isnâ€™t.",
      success:"Correct. Use <b>there</b> (not it)."
    },
    { part:"D", section:"Part D â€” There is / There are", tag:"short answers", type:"mcq",
      qtype:"Short answers (NO typing)",
      prompt:"Choose the best short answer.",
      sentence:"Q: Are there any shops near your home?",
      choices:[
        {t:"Yes, there are.", ok:true},
        {t:"Yes, there is.", ok:false},
        {t:"Yes, they are.", ok:false},
        {t:"Yes, there arenâ€™t.", ok:false}
      ],
      clue:"Plural short answer: Yes, there are.",
      success:"Correct. <b>Yes, there are.</b>"
    },

    // =========================
    // PART E â€” PREPOSITIONS + FIXED EXPRESSIONS (ALL MCQ)
    // =========================
    { part:"E", section:"Part E â€” Prepositions & fixed expressions", tag:"fixed expressions", type:"mcq",
      qtype:"Fixed expression",
      prompt:"Choose the best phrase.",
      sentence:"On weekdays, the children are ____.",
      choices:[
        {t:"at school", ok:true},
        {t:"in school", ok:false},
        {t:"on school", ok:false},
        {t:"to school", ok:false}
      ],
      clue:"We say: at school / at home / at work.",
      success:"Correct. <b>at school</b>."
    },
    { part:"E", section:"Part E â€” Prepositions & fixed expressions", tag:"fixed expressions", type:"mcq",
      qtype:"Fixed expression",
      prompt:"Choose the best phrase.",
      sentence:"He is sick. He is ____.",
      choices:[
        {t:"in bed", ok:true},
        {t:"on bed", ok:false},
        {t:"at bed", ok:false},
        {t:"to bed", ok:false}
      ],
      clue:"We say: in bed.",
      success:"Correct. <b>in bed</b>."
    },
    { part:"E", section:"Part E â€” Prepositions & fixed expressions", tag:"fixed expressions", type:"mcq",
      qtype:"Fixed expression",
      prompt:"Choose the best phrase.",
      sentence:"The supermarket is ____.",
      choices:[
        {t:"on the left", ok:true},
        {t:"at the left", ok:false},
        {t:"in the left", ok:false},
        {t:"to the left (only)", ok:false}
      ],
      clue:"Common: on the left / on the right.",
      success:"Correct. <b>on the left</b>."
    },
    { part:"E", section:"Part E â€” Prepositions & fixed expressions", tag:"corner", type:"mcq",
      qtype:"Corner meaning",
      prompt:"Choose the best phrase.",
      sentence:"The chair is ____ of the room.",
      choices:[
        {t:"in the corner", ok:true},
        {t:"on the corner", ok:false},
        {t:"at the corner", ok:false},
        {t:"under the corner", ok:false}
      ],
      clue:"Inside a room/space â†’ in the corner.",
      success:"Correct. <b>in the corner</b>."
    },
    { part:"E", section:"Part E â€” Prepositions & fixed expressions", tag:"corner", type:"mcq",
      qtype:"Corner meaning",
      prompt:"Choose the best phrase.",
      sentence:"The cafÃ© is ____ of King Street and Park Road.",
      choices:[
        {t:"on the corner", ok:true},
        {t:"in the corner", ok:false},
        {t:"at the corner (not best here)", ok:false},
        {t:"between the corner", ok:false}
      ],
      clue:"Street intersection â†’ on the corner.",
      success:"Correct. <b>on the corner</b>."
    },

    // Picture-based MCQ (still click only)
    { part:"E", section:"Part E â€” Prepositions & fixed expressions", tag:"picture", type:"pic_mcq",
      qtype:"Look at the picture",
      prompt:"Look at the picture. Choose the correct preposition.",
      sentence:"The book is ____ the desk.",
      pic:true,
      choices:[
        {t:"on", ok:true},
        {t:"under", ok:false},
        {t:"between", ok:false},
        {t:"next to", ok:false}
      ],
      clue:"Book is on top of desk.",
      success:"Correct: <b>on</b>."
    },
    { part:"E", section:"Part E â€” Prepositions & fixed expressions", tag:"picture", type:"pic_mcq",
      qtype:"Look at the picture",
      prompt:"Look at the picture. Choose the correct preposition.",
      sentence:"The bag is ____ the chair.",
      pic:true,
      choices:[
        {t:"under", ok:true},
        {t:"on", ok:false},
        {t:"between", ok:false},
        {t:"in", ok:false}
      ],
      clue:"Bag is below the chair.",
      success:"Correct: <b>under</b>."
    },
    { part:"E", section:"Part E â€” Prepositions & fixed expressions", tag:"picture", type:"pic_mcq",
      qtype:"Look at the picture",
      prompt:"Look at the picture. Choose the correct preposition.",
      sentence:"The lamp is ____ the desk and the wall.",
      pic:true,
      choices:[
        {t:"between", ok:true},
        {t:"under", ok:false},
        {t:"behind", ok:false},
        {t:"next to", ok:false}
      ],
      clue:"Lamp is in the middle of desk + wall.",
      success:"Correct: <b>between</b>."
    },
  ];

  // ---------- STATE ----------
  let idx = 0;
  let score = 0;
  let correct = 0;
  let timer = TOTAL_TIME_SEC;
  let timerHandle = null;

  const wrongIds = new Set();
  const wrongTopics = new Set();

  let sequence = ITEMS.slice();
  let reviewMode = false;

  // ---------- DOM ----------
  const sectionTitle = document.getElementById("sectionTitle");
  const sectionTag = document.getElementById("sectionTag");
  const cardArea = document.getElementById("cardArea");
  const doneBox = document.getElementById("doneBox");

  const partTxt = document.getElementById("partTxt");
  const progTxt = document.getElementById("progTxt");
  const scoreTxt = document.getElementById("scoreTxt");
  const timeTxt = document.getElementById("timeTxt");
  const progBar = document.getElementById("progBar");

  const reviewWrongBtn = document.getElementById("reviewWrongBtn");
  const restartBtn = document.getElementById("restartBtn");

  const endMsg = document.getElementById("endMsg");
  const reviewBox = document.getElementById("reviewBox");

  // ---------- HELPERS ----------
  function setProgressUI(){
    const total = sequence.length;
    progTxt.textContent = `${idx+1}/${total}`;
    scoreTxt.textContent = String(score);
    progBar.style.width = `${(idx/total)*100}%`;
    if (!reviewMode) timeTxt.textContent = formatTime(timer);
  }

  function markWrong(item){
    wrongIds.add(item.id);
    wrongTopics.add(`${item.section} â€¢ ${item.tag}`);
  }

  function stopTimer(){
    if (timerHandle){ clearInterval(timerHandle); timerHandle = null; }
  }
  function startTimer(){
    stopTimer();
    timeTxt.textContent = formatTime(timer);
    timerHandle = setInterval(() => {
      timer--;
      if (timer < 0) timer = 0;
      if (!reviewMode) timeTxt.textContent = formatTime(timer);
      if (timer === 0){
        stopTimer();
        showDone(true);
      }
    }, 1000);
  }

  function showDone(timeUp=false){
    cardArea.style.display = "none";
    doneBox.style.display = "block";
    sectionTitle.textContent = timeUp ? "Timeâ€™s up!" : "Finished!";
    sectionTag.textContent = timeUp ? "Stop here" : "Nice work";

    const total = sequence.length;
    endMsg.innerHTML = `You got <b>${correct}</b> correct out of <b>${total}</b>.`;

    const topics = Array.from(wrongTopics);
    let html = "";
    if (topics.length === 0){
      html += `<b>Review:</b> Nothing to review today. Great job.`;
    } else {
      html += `<b>Review reminder:</b> Practice these again:`;
      html += `<div class="chips">` +
        topics.map(t => `<span class="chip">${escapeHtml(t)}</span>`).join("") +
        `</div>`;
    }
    reviewBox.innerHTML = html;

    progBar.style.width = `100%`;
  }

  function next(){
    idx++;
    if (idx >= sequence.length){
      stopTimer();
      showDone(false);
      return;
    }
    render();
  }

  // ---------- RENDER ----------
  function renderClozeClick(item){
    sectionTitle.textContent = item.section;
    sectionTag.textContent = item.tag;
    partTxt.textContent = item.part;

    cardArea.innerHTML = `
      <div class="qtype">${item.section}</div>
      <div class="prompt">${item.prompt}</div>
      <div class="clozeLine">${escapeHtml(item.line).replace("____", `<span class="blank" id="blank">____</span>`)}</div>

      <div class="tileRow" id="tiles"></div>

      <div class="emojiRow" id="emojiRow"></div>
      <div class="feedback" id="fb"><span class="hint">Click an answer.</span></div>

      <div class="controls">
        <button class="smallbtn secondary" id="hintBtn">Hint</button>
        <button class="smallbtn" id="nextBtn" disabled>Next</button>
      </div>
    `;

    const blank = document.getElementById("blank");
    const tiles = document.getElementById("tiles");
    const fb = document.getElementById("fb");
    const emojiRow = document.getElementById("emojiRow");
    const hintBtn = document.getElementById("hintBtn");
    const nextBtn = document.getElementById("nextBtn");

    let locked=false;
    let tries=0;

    function setSmileys(level){
      emojiRow.textContent = level===3?"ðŸ˜„ðŸ˜„ðŸ˜„":level===2?"ðŸ™‚ðŸ™‚":"ðŸ™‚";
    }

    function showClue(){
      fb.innerHTML = `<span class="hint"><b>Clue:</b> ${item.clue}</span>`;
    }

    shuffle(item.options).forEach(opt=>{
      const b=document.createElement("button");
      b.className="tileBtn";
      b.textContent=opt;

      b.addEventListener("click", ()=>{
        if(locked) return;
        tries++;
        blank.textContent = opt;

        if(opt===item.answer){
          locked=true;
          b.classList.add("selected");
          fb.innerHTML = `<span class="good"><b>Correct!</b></span> ${item.success||""}`;
          score++; correct++;
          setSmileys(tries===1?3:tries===2?2:1);
          nextBtn.disabled=false;
          [...tiles.querySelectorAll("button")].forEach(x=>x.disabled=true);
        } else {
          markWrong(item);
          fb.innerHTML = `<span class="bad"><b>Not yet.</b></span> <span class="hint">${item.clue}</span>`;
        }
        setProgressUI();
      });

      tiles.appendChild(b);
    });

    hintBtn.addEventListener("click", ()=>{
      markWrong(item);
      showClue();
      setProgressUI();
    });
    nextBtn.addEventListener("click", ()=>next());
  }

  function renderMCQ(item){
    sectionTitle.textContent = item.section;
    sectionTag.textContent = item.tag || item.qtype || "MCQ";
    partTxt.textContent = item.part;

    cardArea.innerHTML = `
      <div class="qtype">${item.qtype || item.section}</div>
      <div class="prompt">${item.prompt}</div>
      <div class="sentence">${item.sentence || ""}</div>
      ${item.pic ? getRoomSVG() : ""}

      <div class="tileRow" id="choices"></div>

      <div class="emojiRow" id="emojiRow"></div>
      <div class="feedback" id="fb"><span class="hint">Click an answer.</span></div>

      <div class="controls">
        <button class="smallbtn secondary" id="hintBtn">Hint</button>
        <button class="smallbtn" id="nextBtn" disabled>Next</button>
      </div>
    `;

    const choicesDiv = document.getElementById("choices");
    const fb = document.getElementById("fb");
    const emojiRow = document.getElementById("emojiRow");
    const hintBtn = document.getElementById("hintBtn");
    const nextBtn = document.getElementById("nextBtn");

    let locked=false;
    let tries=0;

    function setSmileys(level){
      emojiRow.textContent = level===3?"ðŸ˜„ðŸ˜„ðŸ˜„":level===2?"ðŸ™‚ðŸ™‚":"ðŸ™‚";
    }
    function showClue(){
      fb.innerHTML = `<span class="hint"><b>Clue:</b> ${item.clue}</span>`;
    }

    const shuffled = shuffle(item.choices);
    shuffled.forEach(ch=>{
      const b=document.createElement("button");
      b.className="tileBtn";
      b.textContent=ch.t;

      b.addEventListener("click", ()=>{
        if(locked) return;
        tries++;

        if(ch.ok){
          locked=true;
          b.classList.add("selected");
          fb.innerHTML = `<span class="good"><b>Correct!</b></span> ${item.success||""}`;
          score++; correct++;
          setSmileys(tries===1?3:tries===2?2:1);
          nextBtn.disabled=false;
          [...choicesDiv.querySelectorAll("button")].forEach(x=>x.disabled=true);
        } else {
          markWrong(item);
          fb.innerHTML = `<span class="bad"><b>Not yet.</b></span> <span class="hint">${item.clue}</span>`;
        }
        setProgressUI();
      });

      choicesDiv.appendChild(b);
    });

    hintBtn.addEventListener("click", ()=>{
      markWrong(item);
      showClue();
      setProgressUI();
    });
    nextBtn.addEventListener("click", ()=>next());
  }

  function renderMatching(item){
    sectionTitle.textContent = item.section;
    sectionTag.textContent = item.tag;
    partTxt.textContent = item.part;

    const options = item.pairsB.map(s => {
      // keep "a) ..." -> value "a"
      const letter = s.trim().charAt(0);
      return {letter, text:s};
    });

    cardArea.innerHTML = `
      <div class="qtype">${item.section}</div>
      <div class="prompt">${item.prompt}</div>

      <div class="twoCol">
        <div class="matchBox" id="boxA">
          <div class="matchTitle">A</div>
        </div>
        <div class="matchBox" id="boxB">
          <div class="matchTitle">B (choices)</div>
          <div style="color:var(--muted);font-size:12.5px;line-height:1.35">
            ${item.pairsB.map(x=>escapeHtml(x)).join("<br/>")}
          </div>
        </div>
      </div>

      <div class="smallNote">Click each dropdown and choose the matching letter.</div>

      <div class="emojiRow" id="emojiRow"></div>
      <div class="feedback" id="fb"><span class="hint">Finish all 5, then click <b>Check</b>.</span></div>

      <div class="controls">
        <button class="smallbtn secondary" id="hintBtn">Hint</button>
        <button class="smallbtn secondary" id="checkBtn">Check</button>
        <button class="smallbtn" id="nextBtn" disabled>Next</button>
      </div>
    `;

    const boxA = document.getElementById("boxA");
    const fb = document.getElementById("fb");
    const emojiRow = document.getElementById("emojiRow");
    const hintBtn = document.getElementById("hintBtn");
    const checkBtn = document.getElementById("checkBtn");
    const nextBtn = document.getElementById("nextBtn");

    let locked=false;
    let tries=0;

    function setSmileys(level){
      emojiRow.textContent = level===3?"ðŸ˜„ðŸ˜„ðŸ˜„":level===2?"ðŸ™‚ðŸ™‚":"ðŸ™‚";
    }
    function showClue(){
      fb.innerHTML = `<span class="hint"><b>Clue:</b> ${item.clue}</span>`;
    }

    // build rows
    const selects = [];
    item.pairsA.forEach((aText, i) => {
      const row = document.createElement("div");
      row.className = "matchItem";
      row.innerHTML = `<b>${escapeHtml(aText)}</b>`;
      const sel = document.createElement("select");
      sel.className="matchSel";
      sel.innerHTML = `
        <option value="">Chooseâ€¦</option>
        ${options.map(o => `<option value="${o.letter}">${o.text}</option>`).join("")}
      `;
      row.appendChild(sel);
      boxA.appendChild(row);
      selects.push({sel, row, idx:i});
    });

    function allChosen(){
      return selects.every(x => x.sel.value);
    }

    checkBtn.addEventListener("click", ()=>{
      if(locked) return;
      tries++;
      if(!allChosen()){
        fb.innerHTML = `<span class="bad"><b>Not yet.</b></span> Choose an answer for every line.`;
        return;
      }

      // grade
      let localCorrect = 0;
      selects.forEach(x=>{
        const need = item.answerMap[x.idx]; // like "a"
        const got = x.sel.value;
        x.row.classList.remove("ok","badBorder");
        if(got === need){
          x.row.classList.add("ok");
          localCorrect++;
        } else {
          x.row.classList.add("badBorder");
        }
      });

      if(localCorrect === selects.length){
        locked=true;
        fb.innerHTML = `<span class="good"><b>Correct!</b></span> ${item.success||""}`;
        score++; correct++; // count matching as 1 item
        setSmileys(tries===1?3:tries===2?2:1);
        nextBtn.disabled=false;
        checkBtn.disabled=true;
        selects.forEach(x=>x.sel.disabled=true);
      } else {
        markWrong(item);
        fb.innerHTML = `<span class="bad"><b>Not yet.</b></span> ${localCorrect}/${selects.length} correct. Fix the red ones.`;
      }
      setProgressUI();
    });

    hintBtn.addEventListener("click", ()=>{
      markWrong(item);
      showClue();
      setProgressUI();
    });
    nextBtn.addEventListener("click", ()=>next());
  }

  function render(){
    doneBox.style.display = "none";
    cardArea.style.display = "block";

    const item = sequence[idx];
    if (!item){ showDone(false); return; }

    setProgressUI();

    if(item.type==="cloze_click") renderClozeClick(item);
    else if(item.type==="matching") renderMatching(item);
    else if(item.type==="mcq" || item.type==="pic_mcq") renderMCQ(item);
    else renderMCQ(item);
  }

  // ---------- DONE / REVIEW ----------
  function showDone(timeUp=false){
    cardArea.style.display = "none";
    doneBox.style.display = "block";
    sectionTitle.textContent = timeUp ? "Timeâ€™s up!" : "Finished!";
    sectionTag.textContent = timeUp ? "Stop here" : "Nice work";
    partTxt.textContent = "â€”";

    const total = sequence.length;
    endMsg.innerHTML = `You got <b>${correct}</b> correct out of <b>${total}</b>.`;

    const topics = Array.from(wrongTopics);
    if (topics.length === 0){
      reviewBox.innerHTML = `<b>Review:</b> Nothing to review today. Great job.`;
    } else {
      reviewBox.innerHTML =
        `<b>Review reminder:</b> Practice these again:` +
        `<div class="chips">${topics.map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join("")}</div>`;
    }
    progBar.style.width = `100%`;
  }

  reviewWrongBtn.addEventListener("click", () => {
    const wrongList = ITEMS.filter(it => wrongIds.has(it.id));
    if (wrongList.length === 0){
      alert("Nothing to review. Great job!");
      return;
    }
    reviewMode = true;
    sequence = wrongList;
    idx = 0;
    score = 0; correct = 0;
    stopTimer();
    timeTxt.textContent = "Review";
    render();
  });

  restartBtn.addEventListener("click", () => {
    idx = 0; score = 0; correct = 0;
    timer = TOTAL_TIME_SEC;
    wrongIds.clear(); wrongTopics.clear();
    reviewMode = false;
    sequence = ITEMS.slice();
    render();
    startTimer();
  });

  // ---------- TIMER ----------
  startTimer();
  render();
})();
</script>
</body>
</html>

