<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Grammar Practice ‚Ä¢ Unit 4 (Part 2) + Unit 5</title>
  <style>
    :root{
      --bg:#0f172a;
      --panel:#111c33;
      --card:#0b1226;
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --line:#24324f;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --accent:#60a5fa;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Century Gothic", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% 10%, #1a2a55 0%, var(--bg) 60%);
      color:var(--ink);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 40px}

    header{
      display:flex;gap:12px;align-items:flex-start;justify-content:space-between;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(96,165,250,.15), rgba(96,165,250,.04));
      padding:14px;border-radius:14px;
    }
    .brand{display:flex;gap:12px;align-items:center;min-width:0}
    .logo{
      width:56px;height:56px;object-fit:contain;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(11,18,38,.55);
      padding:6px;flex:0 0 auto;
    }
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35}

    .meta{display:flex;flex-direction:column;gap:8px;align-items:flex-end;min-width:260px}
    .pillrow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      font-size:12px;border:1px solid var(--line);background: rgba(17,28,51,.7);
      padding:6px 10px;border-radius:999px;user-select:none;
    }
    .pill b{color:#fff}
    .bar{
      width:260px;height:10px;background: rgba(255,255,255,.07);
      border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.10);
    }
    .bar>div{
      height:100%;width:0%;
      background: linear-gradient(90deg, #60a5fa, #34d399);
      transition: width .25s ease;
    }

    main{margin-top:14px;display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    @media (max-width: 860px){
      main{grid-template-columns:1fr}
      .meta{align-items:flex-start;min-width:0}
      .pillrow{justify-content:flex-start}
      .bar{width:100%}
    }
    @media (max-width: 520px){ .logo{width:44px;height:44px} }

    .panel{
      border:1px solid var(--line);
      background: rgba(17,28,51,.55);
      border-radius:14px;
      padding:12px;
    }
    .panel h2{
      margin:0 0 10px;font-size:14px;color:#fff;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .tag{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      background: rgba(11,18,38,.7);
      padding:4px 8px;border-radius:999px;
    }

    .card{
      border:1px solid var(--line);
      background: rgba(11,18,38,.7);
      border-radius:14px;
      padding:14px;
    }
    .qtype{font-size:12px;color:var(--muted);margin-bottom:6px}
    .prompt{font-size:16px;line-height:1.35;margin:0 0 10px}
    .sentence{
      font-size:14px;color:#dbe3ff;
      border-left:3px solid rgba(96,165,250,.5);
      padding-left:10px;margin:10px 0 12px;line-height:1.55;
    }
    .mini{font-size:12.5px;color:var(--muted);line-height:1.4;margin-top:8px}
    .feedback{
      margin-top:10px;
      font-size:13px;color:var(--muted);
      line-height:1.4;
      min-height: 22px;
    }
    .feedback b{color:#fff}
    .feedback .good{color: var(--good)}
    .feedback .bad{color: var(--bad)}
    .feedback .hint{color: #cbd5e1}

    .controls{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    button.smallbtn{
      width:auto;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(34,211,238,.20), rgba(31,42,68,.65));
      color:var(--ink);
      border-radius:12px;
      padding:10px 14px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    button.smallbtn.secondary{
      background: linear-gradient(180deg, rgba(96,165,250,.12), rgba(31,42,68,.65));
      border-color: rgba(96,165,250,.25);
    }
    button.smallbtn[disabled]{opacity:.55;cursor:not-allowed}

    /* Tile choice rows (for grammar form selection) */
    .tileRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .tileBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(31,42,68,.7);
      padding:8px 12px;border-radius:999px;
      cursor:pointer;user-select:none;font-size:14px;
      color: var(--ink);
      transition: transform .05s ease, border-color .2s ease;
    }
    .tileBtn:hover{border-color: rgba(96,165,250,.55)}
    .tileBtn:active{transform: translateY(1px)}
    .tileBtn.selected{
      border-color: rgba(34,197,94,.7);
      background: rgba(34,197,94,.18);
    }

    /* Cloze line */
    .clozeLine{
      font-size:16px; line-height:1.6;
      padding:12px 12px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      background: rgba(11,18,38,.45);
    }
    .blank{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:120px;
      padding:2px 8px;
      border-bottom:2px solid rgba(96,165,250,.75);
      color:#fff;
      font-weight:600;
    }

    input.textIn{
      width:min(360px, 100%);
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(31,42,68,.7);
      color:var(--ink);
      font-size:15px;
      outline:none;
    }
    input.textIn:focus{ border-color: rgba(96,165,250,.55); }

    .sideBox{display:flex;flex-direction:column;gap:10px}
    .stat{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--line);
      background: rgba(11,18,38,.65);
      font-size:13px;
    }
    .stat b{color:#fff}
    .list{margin:0;padding-left:18px;color:var(--muted);font-size:12.5px;line-height:1.4}
    .note{
      font-size:12.5px;color:var(--muted);line-height:1.4;
      border-left:3px solid rgba(245,158,11,.55);padding-left:10px;
    }
    .emojiRow{font-size: 20px; line-height: 1; margin-top: 8px; min-height: 24px}

    .done{
      display:none;margin-top:10px;padding:12px;border-radius:14px;
      border:1px solid rgba(34,197,94,.35);
      background: rgba(34,197,94,.10);
    }
    .done h3{margin:0 0 6px;font-size:15px}
    .done p{margin:0;color:var(--muted);font-size:13px;line-height:1.45}
    .reviewBox{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(11,18,38,.55);
      border-radius:12px;
      padding:10px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(31,42,68,.55);
      padding:6px 10px;
      border-radius:999px;
      font-size:12.5px;
      color: var(--ink);
    }

    /* Inline picture */
    .picWrap{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(11,18,38,.45);
      border-radius:12px;
      padding:10px;
      margin:10px 0 10px;
    }
    .picHint{font-size:12.5px;color:var(--muted);margin-top:6px;line-height:1.35}
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <img src="logo.png" alt="Logo" class="logo" />
      <div>
        <h1>Grammar Practice ‚Ä¢ Unit 4 (Part 2) + Unit 5</h1>
        <div class="sub">
          This is a <b>grammar-use</b> review. Read the sentence and choose/type the correct form.<br/>
          Click <b>Next</b> when you understand.
        </div>
      </div>
    </div>

    <div class="meta">
      <div class="pillrow">
        <div class="pill"><b>Progress</b> <span id="progTxt">0/0</span></div>
        <div class="pill"><b>Score</b> <span id="scoreTxt">0</span></div>
        <div class="pill"><b>Time</b> <span id="timeTxt">08:00</span></div>
      </div>
      <div class="bar"><div id="progBar"></div></div>
    </div>
  </header>

  <main>
    <section class="panel">
      <h2>
        <span id="sectionTitle">Loading‚Ä¶</span>
        <span class="tag" id="sectionTag">Practice</span>
      </h2>

      <div class="card" id="cardArea"></div>

      <div class="done" id="doneBox">
        <h3>Finished!</h3>
        <p id="endMsg"></p>

        <div class="reviewBox" id="reviewBox"></div>

        <div class="controls">
          <button class="smallbtn secondary" id="reviewWrongBtn">Practice Review (Only What I Missed)</button>
          <button class="smallbtn" id="restartBtn">Restart</button>
        </div>
      </div>
    </section>

    <aside class="panel sideBox">
      <h2>Quick Info <span class="tag">U4-2 + U5</span></h2>

      <div class="stat"><span>Current task</span> <b id="taskTxt">‚Äî</b></div>
      <div class="stat"><span>Correct / Total</span> <b><span id="correctTxt">0</span>/<span id="totalTxt">0</span></b></div>

      <div class="note">
        <b>How to play:</b><br/>
        ‚Ä¢ Choose or type the correct grammar form.<br/>
        ‚Ä¢ If wrong: read the clue and try again.<br/>
        ‚Ä¢ Click <b>Next</b> only when you understand.
      </div>

      <div>
        <div class="tag" style="display:inline-block;margin-bottom:6px;">Grammar focus</div>
        <ul class="list">
          <li>Possessive adj vs pronouns: my/mine, her/hers, their/theirs</li>
          <li>Whose vs Who‚Äôs</li>
          <li>‚Äôs meanings: <b>possessive</b> / <b>is</b> / <b>has</b></li>
          <li>Have/has got (and US-style have/has)</li>
          <li>There is/are + questions + short answers</li>
          <li>Prepositions + fixed expressions + corner vs corner</li>
        </ul>
      </div>
    </aside>
  </main>
</div>

<script>
(() => {
  const TOTAL_TIME_SEC = 8 * 60;

  // ---------- Picture (room) ----------
  function getRoomSVG(){
    return `
      <div class="picWrap">
        <svg viewBox="0 0 720 240" width="100%" height="auto" role="img" aria-label="Room picture">
          <rect x="0" y="160" width="720" height="80" fill="rgba(96,165,250,.08)"></rect>
          <rect x="640" y="0" width="10" height="240" fill="rgba(245,158,11,.25)"></rect>
          <text x="655" y="20" font-size="12" fill="rgba(156,163,175,.9)">WALL</text>

          <rect x="60" y="90" width="180" height="20" rx="6" fill="rgba(96,165,250,.35)"></rect>
          <rect x="70" y="110" width="20" height="60" fill="rgba(96,165,250,.22)"></rect>
          <rect x="210" y="110" width="20" height="60" fill="rgba(96,165,250,.22)"></rect>
          <text x="65" y="80" font-size="12" fill="rgba(156,163,175,.9)">DESK</text>

          <rect x="120" y="65" width="60" height="25" rx="4" fill="rgba(34,197,94,.35)" stroke="rgba(34,197,94,.55)"></rect>
          <text x="127" y="82" font-size="12" fill="rgba(229,231,235,.95)">BOOK</text>

          <rect x="310" y="105" width="100" height="18" rx="6" fill="rgba(156,163,175,.25)"></rect>
          <rect x="322" y="123" width="14" height="60" fill="rgba(156,163,175,.18)"></rect>
          <rect x="384" y="123" width="14" height="60" fill="rgba(156,163,175,.18)"></rect>
          <text x="315" y="95" font-size="12" fill="rgba(156,163,175,.9)">CHAIR</text>

          <rect x="340" y="172" width="40" height="28" rx="6" fill="rgba(239,68,68,.28)" stroke="rgba(239,68,68,.55)"></rect>
          <text x="346" y="191" font-size="12" fill="rgba(229,231,235,.95)">BAG</text>

          <circle cx="520" cy="110" r="16" fill="rgba(245,158,11,.25)" stroke="rgba(245,158,11,.55)"></circle>
          <rect x="515" y="126" width="10" height="40" fill="rgba(245,158,11,.22)"></rect>
          <rect x="500" y="166" width="40" height="10" rx="5" fill="rgba(245,158,11,.22)"></rect>
          <text x="500" y="95" font-size="12" fill="rgba(156,163,175,.9)">LAMP</text>
        </svg>
        <div class="picHint">Use: <b>on</b> (on top) ‚Ä¢ <b>under</b> (below) ‚Ä¢ <b>between</b> (in the middle)</div>
      </div>
    `;
  }

  // ---------- Question types ----------
  // mcq: choose option (grammar choice)
  // formpick: click correct form tiles (like ‚Äúmy / mine‚Äù)
  // typein: students type the correct word/phrase
  // cloze: choose from tiles to fill blank
  // sMeaning: choose meaning of 's (is/has/possessive)
  // picType: picture + type preposition

  const ITEMS = [
    // -------- Unit 4 Part 2: Possessives (use, not vocab) --------
    {
      id:"u4_form_my_mine",
      type:"formpick",
      section:"Unit 4 (Part 2)",
      qtype:"Choose the correct form",
      prompt:"Choose the correct word for the blank.",
      line:"This is ____ book.",
      options:["my","mine","me","I"],
      answer:"my",
      success:"Yes. Before a noun ‚Üí <b>my</b>.",
      clue:"If there is a noun after the blank, use <b>my/your/his/her/our/their</b>."
    },
    {
      id:"u4_form_my_mine2",
      type:"formpick",
      section:"Unit 4 (Part 2)",
      qtype:"Choose the correct form",
      prompt:"Choose the correct word for the blank.",
      line:"This book is ____.",
      options:["my","mine","me","I"],
      answer:"mine",
      success:"Correct. No noun ‚Üí <b>mine</b>.",
      clue:"If there is no noun after the blank, use <b>mine/yours/hers/ours/theirs</b>."
    },
    {
      id:"u4_form_their_theirs",
      type:"formpick",
      section:"Unit 4 (Part 2)",
      qtype:"Choose the correct form",
      prompt:"Choose the correct word for the blank.",
      line:"Those are ____ bags.",
      options:["their","theirs","them","they"],
      answer:"their",
      success:"Yes. Before a noun ‚Üí <b>their</b>.",
      clue:"Before a noun, use possessive adjective: <b>their</b>."
    },
    {
      id:"u4_form_their_theirs2",
      type:"formpick",
      section:"Unit 4 (Part 2)",
      qtype:"Choose the correct form",
      prompt:"Choose the correct word for the blank.",
      line:"Those bags are ____.",
      options:["their","theirs","them","they"],
      answer:"theirs",
      success:"Correct. No noun ‚Üí <b>theirs</b>.",
      clue:"No noun after blank ‚Üí use possessive pronoun: theirs."
    },

    // Whose / Who‚Äôs
    {
      id:"u4_whose_whos_type",
      type:"typein",
      section:"Unit 4 (Part 2)",
      qtype:"Type the correct word",
      prompt:"Type the correct word: <b>Whose</b> or <b>Who‚Äôs</b>.",
      sentence:`_____ pencil is this?`,
      answer:"whose",
      accept:["whose"],
      success:"Correct. <b>Whose</b> asks about ownership.",
      clue:"Whose = belongs to who. Who‚Äôs = who is."
    },

    // 's meaning: possessive vs is vs has
    {
      id:"u4_s_meaning1",
      type:"mcq",
      section:"Unit 4 (Part 2)",
      qtype:"What does ‚Äôs mean?",
      prompt:"In this sentence, what does <b>Tom‚Äôs</b> mean?",
      sentence:"Tom‚Äôs backpack is under the chair.",
      choices:[
        {t:"Tom owns the backpack (possessive).", ok:true},
        {t:"Tom is a backpack.", ok:false},
        {t:"Tom has got (always).", ok:false},
        {t:"Tom was.", ok:false}
      ],
      success:"Correct. Name + ‚Äôs + noun ‚Üí <b>belongs to</b>.",
      clue:"If ‚Äôs is on a name before a noun, it usually means <b>belongs to</b>."
    },
    {
      id:"u4_s_meaning2",
      type:"mcq",
      section:"Unit 4 (Part 2)",
      qtype:"What does ‚Äôs mean?",
      prompt:"In this sentence, what does <b>It‚Äôs</b> mean?",
      sentence:"It‚Äôs on the desk.",
      choices:[
        {t:"It is", ok:true},
        {t:"It has", ok:false},
        {t:"It owns", ok:false},
        {t:"Its (possessive adjective)", ok:false}
      ],
      success:"Yes. It‚Äôs = <b>It is</b>.",
      clue:"It‚Äôs (with apostrophe) = It is. Its (no apostrophe) = belonging to it."
    },
    {
      id:"u4_s_meaning3",
      type:"mcq",
      section:"Unit 4 (Part 2)",
      qtype:"What does ‚Äôs mean?",
      prompt:"In this sentence, what does <b>She‚Äôs got</b> mean?",
      sentence:"She‚Äôs got a new pencil case.",
      choices:[
        {t:"She has got", ok:true},
        {t:"She is got", ok:false},
        {t:"She owns got", ok:false},
        {t:"She was got", ok:false}
      ],
      success:"Correct. She‚Äôs got = <b>She has got</b>.",
      clue:"‚Äôs got = has got (NOT is)."
    },

    // Have / has got vs have / has (US)
    {
      id:"u4_have_got_transform",
      type:"cloze",
      section:"Unit 4 (Part 2)",
      qtype:"Choose the correct form (meaning = have)",
      prompt:"Choose the best phrase to complete the sentence.",
      sentence:"(Same meaning as: I have two brothers.)",
      line:"I ____ two brothers.",
      options:["have got","has got","am got","got"],
      answer:"have got",
      success:"Yes. I have got‚Ä¶ (BrE).",
      clue:"I/you/we/they ‚Üí have got. He/she/it ‚Üí has got."
    },
    {
      id:"u4_us_have_no_got",
      type:"mcq",
      section:"Unit 4 (Part 2)",
      qtype:"US style (no got)",
      prompt:"In American English, people often say:",
      sentence:"(Meaning: She has got a bike.)",
      choices:[
        {t:"She has a bike.", ok:true},
        {t:"She is a bike.", ok:false},
        {t:"She have a bike.", ok:false},
        {t:"She got a bike (same meaning here).", ok:false}
      ],
      success:"Correct. US: <b>has/have</b> is very common (no got).",
      clue:"US English: have/has (no got) is common: She has a bike."
    },

    // -------- Unit 5: There is/are + questions + short answers --------
    {
      id:"u5_there_is_are_choose",
      type:"cloze",
      section:"Unit 5",
      qtype:"There is / There are",
      prompt:"Choose the correct phrase.",
      sentence:"(One thing)",
      line:"____ a lamp on the desk.",
      options:["There is","There are"],
      answer:"There is",
      success:"Correct. One lamp ‚Üí <b>There is</b>.",
      clue:"Singular (one) ‚Üí There is."
    },
    {
      id:"u5_there_is_are_choose2",
      type:"cloze",
      section:"Unit 5",
      qtype:"There is / There are",
      prompt:"Choose the correct phrase.",
      sentence:"(Two things)",
      line:"____ two books on the chair.",
      options:["There is","There are"],
      answer:"There are",
      success:"Correct. Two books ‚Üí <b>There are</b>.",
      clue:"Plural (2+) ‚Üí There are."
    },
    {
      id:"u5_question_form",
      type:"formpick",
      section:"Unit 5",
      qtype:"Question form",
      prompt:"Choose the correct start of the question.",
      line:"____ there any pencils on the desk?",
      options:["Is","Are","Do","Does"],
      answer:"Are",
      success:"Correct. Plural ‚Üí <b>Are there‚Ä¶?</b>",
      clue:"Any + plural ‚Üí Are there‚Ä¶?"
    },
    {
      id:"u5_short_answer_type",
      type:"typein",
      section:"Unit 5",
      qtype:"Short answers",
      prompt:"Type the correct short answer (use: <b>Yes, there is.</b>)",
      sentence:"Question: Is there a computer in the classroom?",
      answer:"yes, there is.",
      accept:["yes, there is.","yes there is","yes, there is"],
      success:"Correct. Short answer uses <b>there</b> (not it).",
      clue:"Short answer pattern: Yes, there is. / No, there isn‚Äôt."
    },

    // Fixed expressions (small set)
    {
      id:"u5_fixed_at_school",
      type:"formpick",
      section:"Unit 5",
      qtype:"Fixed expressions",
      prompt:"Choose the best phrase.",
      line:"On weekdays, the children are ____.",
      options:["at school","in school","on school"],
      answer:"at school",
      success:"Correct: <b>at school</b>.",
      clue:"Fixed chunks: at school / at home / at work."
    },
    {
      id:"u5_fixed_in_bed",
      type:"formpick",
      section:"Unit 5",
      qtype:"Fixed expressions",
      prompt:"Choose the best phrase.",
      line:"He is sick. He is ____.",
      options:["in bed","on bed","at bed"],
      answer:"in bed",
      success:"Correct: <b>in bed</b>.",
      clue:"We say in bed (sleeping/resting)."
    },
    {
      id:"u5_fixed_on_left",
      type:"formpick",
      section:"Unit 5",
      qtype:"Fixed expressions",
      prompt:"Choose the best phrase.",
      line:"The bank is ____.",
      options:["on the left","at the left","in the left"],
      answer:"on the left",
      success:"Correct: <b>on the left</b>.",
      clue:"We say on the left / on the right."
    },

    // In the corner vs on the corner
    {
      id:"u5_corner_in",
      type:"formpick",
      section:"Unit 5",
      qtype:"Corner expressions",
      prompt:"Choose the best phrase.",
      line:"The chair is ____ of the room.",
      options:["in the corner","on the corner"],
      answer:"in the corner",
      success:"Yes. Inside a room ‚Üí <b>in the corner</b>.",
      clue:"Inside a room/space ‚Üí in the corner."
    },
    {
      id:"u5_corner_on",
      type:"formpick",
      section:"Unit 5",
      qtype:"Corner expressions",
      prompt:"Choose the best phrase.",
      line:"The caf√© is ____ of King Street and Park Road.",
      options:["on the corner","in the corner"],
      answer:"on the corner",
      success:"Correct. Street corner ‚Üí <b>on the corner</b>.",
      clue:"Street intersection ‚Üí on the corner."
    },

    // Picture + type prepositions (more ‚Äúuse‚Äù)
    {
      id:"u5_pic_type1",
      type:"picType",
      section:"Unit 5",
      qtype:"Prepositions (type)",
      prompt:"Look at the picture. Type ONE word.",
      sentence:"The bag is ____ the chair.",
      pic:true,
      answer:"under",
      accept:["under"],
      success:"Correct: under.",
      clue:"Under = below."
    },
    {
      id:"u5_pic_type2",
      type:"picType",
      section:"Unit 5",
      qtype:"Prepositions (type)",
      prompt:"Look at the picture. Type ONE word.",
      sentence:"The book is ____ the desk.",
      pic:true,
      answer:"on",
      accept:["on"],
      success:"Correct: on.",
      clue:"On = on top."
    },
    {
      id:"u5_pic_type3",
      type:"picType",
      section:"Unit 5",
      qtype:"Prepositions (type)",
      prompt:"Look at the picture. Type ONE word.",
      sentence:"The lamp is ____ the desk and the wall.",
      pic:true,
      answer:"between",
      accept:["between"],
      success:"Correct: between.",
      clue:"Between = in the middle of two things."
    },
  ];

  // ---------- STATE ----------
  let idx = 0;
  let score = 0;
  let correct = 0;
  let timer = TOTAL_TIME_SEC;
  let timerHandle = null;

  const wrongIds = new Set();
  const wrongTopics = new Set();
  const attempts = new Map();

  let sequence = ITEMS.slice();
  let reviewMode = false;

  // ---------- DOM ----------
  const sectionTitle = document.getElementById("sectionTitle");
  const sectionTag = document.getElementById("sectionTag");
  const cardArea = document.getElementById("cardArea");
  const doneBox = document.getElementById("doneBox");

  const progTxt = document.getElementById("progTxt");
  const scoreTxt = document.getElementById("scoreTxt");
  const timeTxt = document.getElementById("timeTxt");
  const progBar = document.getElementById("progBar");

  const taskTxt = document.getElementById("taskTxt");
  const correctTxt = document.getElementById("correctTxt");
  const totalTxt = document.getElementById("totalTxt");

  const reviewWrongBtn = document.getElementById("reviewWrongBtn");
  const restartBtn = document.getElementById("restartBtn");

  const endMsg = document.getElementById("endMsg");
  const reviewBox = document.getElementById("reviewBox");

  // ---------- HELPERS ----------
  function shuffle(arr){
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }
  function formatTime(sec){
    const m = String(Math.floor(sec/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");
    return `${m}:${s}`;
  }
  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }
  function norm(s){
    return String(s||"").trim().toLowerCase().replace(/\s+/g," ");
  }

  function setProgressUI(){
    progTxt.textContent = `${idx+1}/${sequence.length}`;
    scoreTxt.textContent = String(score);
    correctTxt.textContent = String(correct);
    totalTxt.textContent = String(sequence.length);
    progBar.style.width = `${(idx/sequence.length)*100}%`;
    timeTxt.textContent = reviewMode ? "Review" : formatTime(timer);
  }

  function markWrong(item){
    wrongIds.add(item.id);
    wrongTopics.add(`${item.section} ‚Ä¢ ${item.qtype}`);
  }

  function stopTimer(){
    if (timerHandle){ clearInterval(timerHandle); timerHandle = null; }
  }
  function startTimer(){
    stopTimer();
    timeTxt.textContent = formatTime(timer);
    timerHandle = setInterval(() => {
      timer--;
      if (timer < 0) timer = 0;
      if (!reviewMode) timeTxt.textContent = formatTime(timer);
      if (timer === 0){
        stopTimer();
        showDone(true);
      }
    }, 1000);
  }

  function showDone(timeUp=false){
    cardArea.style.display = "none";
    doneBox.style.display = "block";
    sectionTitle.textContent = timeUp ? "Time‚Äôs up!" : "Finished!";
    sectionTag.textContent = timeUp ? "Stop here" : "Nice work";
    taskTxt.textContent = timeUp ? "Time limit reached" : "Completed";

    const total = sequence.length;
    endMsg.innerHTML = `You got <b>${correct}</b> correct out of <b>${total}</b>.`;

    const topics = Array.from(wrongTopics);
    let html = "";
    if (topics.length === 0){
      html += `<b>Review:</b> Nothing to review today. Great job.`;
    } else {
      html += `<b>Review reminder:</b> Practice these again before written homework:`;
      html += `<div class="chips">` +
        topics.map(t => `<span class="chip">${escapeHtml(t)}</span>`).join("") +
        `</div>`;
      html += `<div style="margin-top:10px;">Tip: Say 2 example sentences out loud before you write.</div>`;
    }
    reviewBox.innerHTML = html;

    progBar.style.width = `100%`;
  }

  function next(){
    idx++;
    if (idx >= sequence.length){
      stopTimer();
      showDone(false);
      return;
    }
    render();
  }

  // ---------- RENDERERS ----------
  function renderMCQ(item){
    sectionTitle.textContent = item.section;
    sectionTag.textContent = item.qtype;
    const id = item.id;
    attempts.set(id, attempts.get(id) || 0);

    cardArea.innerHTML = `
      <div class="qtype">${item.qtype}</div>
      <div class="prompt">${item.prompt}</div>
      <div class="sentence">${item.sentence || ""}</div>
      <div class="tileRow" id="choices"></div>

      <div class="emojiRow" id="emojiRow"></div>
      <div class="feedback" id="fb"><span class="hint">Click an answer.</span></div>

      <div class="controls">
        <button class="smallbtn secondary" id="hintBtn">Hint</button>
        <button class="smallbtn" id="nextBtn" disabled>Next</button>
      </div>
    `;

    const choicesDiv = document.getElementById("choices");
    const fb = document.getElementById("fb");
    const emojiRow = document.getElementById("emojiRow");
    const hintBtn = document.getElementById("hintBtn");
    const nextBtn = document.getElementById("nextBtn");

    let locked = false;
    function setSmileys(level){
      emojiRow.textContent = level===3?"üòÑüòÑüòÑ":level===2?"üôÇüôÇ":"üôÇ";
    }
    function showClue(){
      fb.innerHTML = `<span class="hint"><b>Clue:</b> ${item.clue}</span>`;
    }

    const shuffled = shuffle(item.choices);
    shuffled.forEach(ch=>{
      const b = document.createElement("button");
      b.className="tileBtn";
      b.textContent = ch.t;
      b.addEventListener("click", ()=>{
        if(locked) return;
        attempts.set(id,(attempts.get(id)||0)+1);
        const a = attempts.get(id);
        if(ch.ok){
          locked=true;
          b.classList.add("selected");
          fb.innerHTML = `<span class="good"><b>Correct!</b></span> ${item.success||""}`;
          score++; correct++;
          setSmileys(a===1?3:a===2?2:1);
          nextBtn.disabled=false;
          [...choicesDiv.querySelectorAll("button")].forEach(x=>x.disabled=true);
        } else {
          markWrong(item);
          fb.innerHTML = `<span class="bad"><b>Not yet.</b></span> <span class="hint">${item.clue}</span>`;
        }
        setProgressUI();
      });
      choicesDiv.appendChild(b);
    });

    hintBtn.addEventListener("click", ()=>{
      attempts.set(id,(attempts.get(id)||0)+1);
      markWrong(item);
      showClue();
      setProgressUI();
    });
    nextBtn.addEventListener("click", ()=>next());
    taskTxt.textContent = item.section;
  }

  function renderFormPick(item){
    sectionTitle.textContent = item.section;
    sectionTag.textContent = item.qtype;
    const id = item.id;
    attempts.set(id, attempts.get(id) || 0);

    cardArea.innerHTML = `
      <div class="qtype">${item.qtype}</div>
      <div class="prompt">${item.prompt}</div>

      <div class="clozeLine">${escapeHtml(item.line).replace("____", `<span class="blank" id="blank">____</span>`)}</div>

      <div class="tileRow" id="tiles"></div>

      <div class="emojiRow" id="emojiRow"></div>
      <div class="feedback" id="fb"><span class="hint">Click the best form.</span></div>

      <div class="controls">
        <button class="smallbtn secondary" id="hintBtn">Hint</button>
        <button class="smallbtn" id="nextBtn" disabled>Next</button>
      </div>
    `;

    const blank = document.getElementById("blank");
    const tiles = document.getElementById("tiles");
    const fb = document.getElementById("fb");
    const emojiRow = document.getElementById("emojiRow");
    const hintBtn = document.getElementById("hintBtn");
    const nextBtn = document.getElementById("nextBtn");

    let locked=false;
    function setSmileys(level){
      emojiRow.textContent = level===3?"üòÑüòÑüòÑ":level===2?"üôÇüôÇ":"üôÇ";
    }
    function showClue(){
      fb.innerHTML = `<span class="hint"><b>Clue:</b> ${item.clue}</span>`;
    }

    shuffle(item.options).forEach(opt=>{
      const b=document.createElement("button");
      b.className="tileBtn";
      b.textContent=opt;
      b.addEventListener("click", ()=>{
        if(locked) return;
        attempts.set(id,(attempts.get(id)||0)+1);
        const a = attempts.get(id);

        blank.textContent = opt;

        if(norm(opt)===norm(item.answer)){
          locked=true;
          b.classList.add("selected");
          fb.innerHTML = `<span class="good"><b>Correct!</b></span> ${item.success||""}`;
          score++; correct++;
          setSmileys(a===1?3:a===2?2:1);
          nextBtn.disabled=false;
          [...tiles.querySelectorAll("button")].forEach(x=>x.disabled=true);
        } else {
          markWrong(item);
          fb.innerHTML = `<span class="bad"><b>Not yet.</b></span> <span class="hint">${item.clue}</span>`;
        }
        setProgressUI();
      });
      tiles.appendChild(b);
    });

    hintBtn.addEventListener("click", ()=>{
      attempts.set(id,(attempts.get(id)||0)+1);
      markWrong(item);
      showClue();
      setProgressUI();
    });
    nextBtn.addEventListener("click", ()=>next());
    taskTxt.textContent = item.section;
  }

  function renderCloze(item){
    sectionTitle.textContent = item.section;
    sectionTag.textContent = item.qtype;
    const id = item.id;
    attempts.set(id, attempts.get(id) || 0);

    cardArea.innerHTML = `
      <div class="qtype">${item.qtype}</div>
      <div class="prompt">${item.prompt}</div>
      <div class="sentence">${item.sentence || ""}</div>

      <div class="clozeLine">${escapeHtml(item.line).replace("____", `<span class="blank" id="blank">____</span>`)}</div>
      <div class="tileRow" id="tiles"></div>

      <div class="emojiRow" id="emojiRow"></div>
      <div class="feedback" id="fb"><span class="hint">Click the best phrase.</span></div>

      <div class="controls">
        <button class="smallbtn secondary" id="hintBtn">Hint</button>
        <button class="smallbtn" id="nextBtn" disabled>Next</button>
      </div>
    `;

    const blank = document.getElementById("blank");
    const tiles = document.getElementById("tiles");
    const fb = document.getElementById("fb");
    const emojiRow = document.getElementById("emojiRow");
    const hintBtn = document.getElementById("hintBtn");
    const nextBtn = document.getElementById("nextBtn");

    let locked=false;
    function setSmileys(level){
      emojiRow.textContent = level===3?"üòÑüòÑüòÑ":level===2?"üôÇüôÇ":"üôÇ";
    }
    function showClue(){
      fb.innerHTML = `<span class="hint"><b>Clue:</b> ${item.clue}</span>`;
    }

    shuffle(item.options).forEach(opt=>{
      const b=document.createElement("button");
      b.className="tileBtn";
      b.textContent=opt;
      b.addEventListener("click", ()=>{
        if(locked) return;
        attempts.set(id,(attempts.get(id)||0)+1);
        const a = attempts.get(id);

        blank.textContent = opt;

        if(norm(opt)===norm(item.answer)){
          locked=true;
          b.classList.add("selected");
          fb.innerHTML = `<span class="good"><b>Correct!</b></span> ${item.success||""}`;
          score++; correct++;
          setSmileys(a===1?3:a===2?2:1);
          nextBtn.disabled=false;
          [...tiles.querySelectorAll("button")].forEach(x=>x.disabled=true);
        } else {
          markWrong(item);
          fb.innerHTML = `<span class="bad"><b>Not yet.</b></span> <span class="hint">${item.clue}</span>`;
        }
        setProgressUI();
      });
      tiles.appendChild(b);
    });

    hintBtn.addEventListener("click", ()=>{
      attempts.set(id,(attempts.get(id)||0)+1);
      markWrong(item);
      showClue();
      setProgressUI();
    });
    nextBtn.addEventListener("click", ()=>next());
    taskTxt.textContent = item.section;
  }

  function renderTypeIn(item){
    sectionTitle.textContent = item.section;
    sectionTag.textContent = item.qtype;
    const id = item.id;
    attempts.set(id, attempts.get(id) || 0);

    cardArea.innerHTML = `
      <div class="qtype">${item.qtype}</div>
      <div class="prompt">${item.prompt}</div>
      <div class="sentence">${escapeHtml(item.sentence || "")}</div>

      <div class="clozeLine" style="margin-top:10px;">
        <input class="textIn" id="ans" placeholder="Type here‚Ä¶" autocomplete="off" />
      </div>

      <div class="mini">Tip: Don‚Äôt use extra words. Type only the missing word/short answer.</div>

      <div class="emojiRow" id="emojiRow"></div>
      <div class="feedback" id="fb"><span class="hint">Type your answer, then click <b>Check</b>.</span></div>

      <div class="controls">
        <button class="smallbtn secondary" id="hintBtn">Hint</button>
        <button class="smallbtn secondary" id="checkBtn">Check</button>
        <button class="smallbtn" id="nextBtn" disabled>Next</button>
      </div>
    `;

    const ans = document.getElementById("ans");
    const fb = document.getElementById("fb");
    const emojiRow = document.getElementById("emojiRow");
    const hintBtn = document.getElementById("hintBtn");
    const checkBtn = document.getElementById("checkBtn");
    const nextBtn = document.getElementById("nextBtn");

    let locked=false;
    function setSmileys(level){
      emojiRow.textContent = level===3?"üòÑüòÑüòÑ":level===2?"üôÇüôÇ":"üôÇ";
    }
    function showClue(){
      fb.innerHTML = `<span class="hint"><b>Clue:</b> ${item.clue}</span>`;
    }

    function check(){
      if(locked) return;
      attempts.set(id,(attempts.get(id)||0)+1);
      const a = attempts.get(id);

      const user = norm(ans.value);
      const ok = (item.accept||[]).map(norm).includes(user) || user===norm(item.answer);

      if(ok){
        locked=true;
        fb.innerHTML = `<span class="good"><b>Correct!</b></span> ${item.success||""}`;
        score++; correct++;
        setSmileys(a===1?3:a===2?2:1);
        nextBtn.disabled=false;
        ans.disabled=true;
        checkBtn.disabled=true;
      } else {
        markWrong(item);
        fb.innerHTML = `<span class="bad"><b>Not yet.</b></span> <span class="hint">${item.clue}</span>`;
      }
      setProgressUI();
    }

    checkBtn.addEventListener("click", check);
    ans.addEventListener("keydown", (e)=>{ if(e.key==="Enter") check(); });

    hintBtn.addEventListener("click", ()=>{
      attempts.set(id,(attempts.get(id)||0)+1);
      markWrong(item);
      showClue();
      setProgressUI();
    });
    nextBtn.addEventListener("click", ()=>next());
    taskTxt.textContent = item.section;
  }

  function renderPicType(item){
    sectionTitle.textContent = item.section;
    sectionTag.textContent = item.qtype;
    const id = item.id;
    attempts.set(id, attempts.get(id) || 0);

    cardArea.innerHTML = `
      <div class="qtype">${item.qtype}</div>
      <div class="prompt">${item.prompt}</div>
      <div class="sentence">${escapeHtml(item.sentence || "")}</div>

      ${getRoomSVG()}

      <div class="clozeLine" style="margin-top:10px;">
        <input class="textIn" id="ans" placeholder="Type ONE word (on / under / between)..." autocomplete="off" />
      </div>

      <div class="emojiRow" id="emojiRow"></div>
      <div class="feedback" id="fb"><span class="hint">Type your answer, then click <b>Check</b>.</span></div>

      <div class="controls">
        <button class="smallbtn secondary" id="hintBtn">Hint</button>
        <button class="smallbtn secondary" id="checkBtn">Check</button>
        <button class="smallbtn" id="nextBtn" disabled>Next</button>
      </div>
    `;

    const ans = document.getElementById("ans");
    const fb = document.getElementById("fb");
    const emojiRow = document.getElementById("emojiRow");
    const hintBtn = document.getElementById("hintBtn");
    const checkBtn = document.getElementById("checkBtn");
    const nextBtn = document.getElementById("nextBtn");

    let locked=false;
    function setSmileys(level){
      emojiRow.textContent = level===3?"üòÑüòÑüòÑ":level===2?"üôÇüôÇ":"üôÇ";
    }
    function showClue(){
      fb.innerHTML = `<span class="hint"><b>Clue:</b> ${item.clue}</span>`;
    }

    function check(){
      if(locked) return;
      attempts.set(id,(attempts.get(id)||0)+1);
      const a = attempts.get(id);

      const user = norm(ans.value);
      const ok = (item.accept||[]).map(norm).includes(user) || user===norm(item.answer);

      if(ok){
        locked=true;
        fb.innerHTML = `<span class="good"><b>Correct!</b></span> ${item.success||""}`;
        score++; correct++;
        setSmileys(a===1?3:a===2?2:1);
        nextBtn.disabled=false;
        ans.disabled=true;
        checkBtn.disabled=true;
      } else {
        markWrong(item);
        fb.innerHTML = `<span class="bad"><b>Not yet.</b></span> <span class="hint">${item.clue}</span>`;
      }
      setProgressUI();
    }

    checkBtn.addEventListener("click", check);
    ans.addEventListener("keydown",(e)=>{ if(e.key==="Enter") check(); });

    hintBtn.addEventListener("click", ()=>{
      attempts.set(id,(attempts.get(id)||0)+1);
      markWrong(item);
      showClue();
      setProgressUI();
    });
    nextBtn.addEventListener("click", ()=>next());
    taskTxt.textContent = item.section;
  }

  function render(){
    doneBox.style.display = "none";
    cardArea.style.display = "block";

    const item = sequence[idx];
    if (!item){ showDone(false); return; }

    setProgressUI();

    if(item.type==="mcq") renderMCQ(item);
    else if(item.type==="formpick") renderFormPick(item);
    else if(item.type==="cloze") renderCloze(item);
    else if(item.type==="typein") renderTypeIn(item);
    else if(item.type==="picType") renderPicType(item);
    else renderMCQ(item);
  }

  // ---------- REVIEW MODE ----------
  reviewWrongBtn.addEventListener("click", () => {
    const wrongList = ITEMS.filter(it => wrongIds.has(it.id));
    if (wrongList.length === 0){
      alert("Nothing to review. Great job!");
      return;
    }
    reviewMode = true;
    sequence = wrongList;
    idx = 0;
    score = 0; correct = 0;
    stopTimer();
    timeTxt.textContent = "Review";
    doneBox.style.display = "none";
    cardArea.style.display = "block";
    render();
  });

  // ---------- RESTART ----------
  restartBtn.addEventListener("click", () => {
    idx = 0; score = 0; correct = 0;
    timer = TOTAL_TIME_SEC;
    wrongIds.clear(); wrongTopics.clear();
    attempts.clear();
    reviewMode = false;
    sequence = ITEMS.slice();
    doneBox.style.display = "none";
    cardArea.style.display = "block";
    render();
    startTimer();
  });

  // ---------- INIT ----------
  totalTxt.textContent = String(ITEMS.length);
  render();
  startTimer();
})();
</script>
</body>
</html>
